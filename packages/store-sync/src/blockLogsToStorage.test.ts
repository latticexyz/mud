import { beforeEach, describe, expect, it, vi } from "vitest";
import { blockLogsToStorage } from "./blockLogsToStorage";
import storeConfig from "@latticexyz/store/mud.config";
import { isDefined } from "@latticexyz/common/utils";
import { tableIdToHex } from "@latticexyz/common";
import { StorageAdapter } from "./common";

const mockedCallbacks = {
  registerTables: vi.fn<Parameters<StorageAdapter["registerTables"]>, ReturnType<StorageAdapter["registerTables"]>>(),
  getTables: vi.fn<Parameters<StorageAdapter["getTables"]>, ReturnType<StorageAdapter["getTables"]>>(),
  storeOperations: vi.fn<
    Parameters<StorageAdapter["storeOperations"]>,
    ReturnType<StorageAdapter["storeOperations"]>
  >(),
};

const mockedDecode = blockLogsToStorage<typeof storeConfig>(
  mockedCallbacks as any as StorageAdapter<typeof storeConfig>
);

describe("blockLogsToStorage", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it("call setField with data properly decoded", async () => {
    mockedCallbacks.getTables.mockImplementation(async ({ tables }) => {
      return tables
        .map((table) => {
          if (table.namespace === "" && table.name === "Inventory") {
            return {
              ...table,
              tableId: tableIdToHex("", "Inventory"),
              keySchema: {
                owner: "address",
                item: "uint32",
                itemVariant: "uint32",
              } as const,
              valueSchema: {
                amount: "uint32",
              } as const,
            };
          }
        })
        .filter(isDefined);
    });

    const operations = await mockedDecode({
      blockNumber: 5448n,
      logs: [
        {
          address: "0x5fbdb2315678afecb367f032d93f642f64180aa3",
          topics: ["0x912af873e852235aae78a1d25ae9bb28b616a67c36898c53a14fd8184504ee32"],
          data: "0x6d756473746f726500000000000000005461626c657300000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000496e76656e746f72790000000000000000000000000000000000000000000000000000000000000000000000000002800004010004000000000000000000000000000000000000000000000000000000001c030061030300000000000000000000000000000000000000000000000000000401000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000001600000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000056f776e657200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000046974656d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b6974656d56617269616e740000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000006616d6f756e740000000000000000000000000000000000000000000000000000",
          blockHash: "0x50b3e15ef79abc7c72126ca5ecbd0cf0773c48ade0528e1e3debaf9bbe3643da",
          blockNumber: 5448n,
          transactionHash: "0xd66a9f982ddb8da9ca15a72c5713c3390fb3a6c2f7fe81a8c9026d0ba8130189",
          transactionIndex: 16,
          logIndex: 53,
          removed: false,
          args: {
            table: "0x6d756473746f726500000000000000005461626c657300000000000000000000",
            key: ["0x00000000000000000000000000000000496e76656e746f727900000000000000"],
            data: "0x0004010004000000000000000000000000000000000000000000000000000000001c030061030300000000000000000000000000000000000000000000000000000401000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000001600000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000056f776e657200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000046974656d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b6974656d56617269616e740000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000006616d6f756e740000000000000000000000000000000000000000000000000000",
          },
          eventName: "StoreSetRecord",
        },
        {
          address: "0x5fbdb2315678afecb367f032d93f642f64180aa3",
          topics: ["0xd01f9f1368f831528fc9fe6442366b2b7d957fbfff3bcf7c24d9ab5fe51f8c46"],
          data: "0x00000000000000000000000000000000496e76656e746f7279000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000796eb990a3f9c431c69149c7a168b91596d87f600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000040000000800000000000000000000000000000000000000000000000000000000",
          blockHash: "0x03e962e7402b2ab295b92feac342a132111dd14b0d1fd4d4a0456fdc77981577",
          blockNumber: 5448n,
          transactionHash: "0xa6986924609542dc4c2d81c53799d8eab47109ef34ee1e422de595e19ee9bfa4",
          transactionIndex: 88,
          logIndex: 88,
          removed: false,
          args: {
            table: "0x00000000000000000000000000000000496e76656e746f727900000000000000",
            key: [
              "0x000000000000000000000000796eb990a3f9c431c69149c7a168b91596d87f60",
              "0x0000000000000000000000000000000000000000000000000000000000000001",
              "0x0000000000000000000000000000000000000000000000000000000000000001",
            ],
            schemaIndex: 0,
            data: "0x00000008",
          },
          eventName: "StoreSetField",
        },
      ],
    });

    expect(mockedCallbacks.storeOperations).toMatchInlineSnapshot(`
      [MockFunction spy] {
        "calls": [
          [
            {
              "blockNumber": 5448n,
              "operations": [
                {
                  "address": "0x5FbDB2315678afecb367f032d93F642f64180aa3",
                  "fieldName": "amount",
                  "fieldValue": 8,
                  "key": {
                    "item": 1,
                    "itemVariant": 1,
                    "owner": "0x796eb990A3F9C431C69149c7a168b91596D87F60",
                  },
                  "log": {
                    "address": "0x5fbdb2315678afecb367f032d93f642f64180aa3",
                    "args": {
                      "data": "0x00000008",
                      "key": [
                        "0x000000000000000000000000796eb990a3f9c431c69149c7a168b91596d87f60",
                        "0x0000000000000000000000000000000000000000000000000000000000000001",
                        "0x0000000000000000000000000000000000000000000000000000000000000001",
                      ],
                      "schemaIndex": 0,
                      "table": "0x00000000000000000000000000000000496e76656e746f727900000000000000",
                    },
                    "blockHash": "0x03e962e7402b2ab295b92feac342a132111dd14b0d1fd4d4a0456fdc77981577",
                    "blockNumber": 5448n,
                    "data": "0x00000000000000000000000000000000496e76656e746f7279000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000796eb990a3f9c431c69149c7a168b91596d87f600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000040000000800000000000000000000000000000000000000000000000000000000",
                    "eventName": "StoreSetField",
                    "logIndex": 88,
                    "removed": false,
                    "topics": [
                      "0xd01f9f1368f831528fc9fe6442366b2b7d957fbfff3bcf7c24d9ab5fe51f8c46",
                    ],
                    "transactionHash": "0xa6986924609542dc4c2d81c53799d8eab47109ef34ee1e422de595e19ee9bfa4",
                    "transactionIndex": 88,
                  },
                  "name": "Inventory",
                  "namespace": "",
                  "type": "SetField",
                },
              ],
            },
          ],
        ],
        "results": [
          {
            "type": "return",
            "value": undefined,
          },
        ],
      }
    `);

    expect(operations).toMatchInlineSnapshot(`
      {
        "blockNumber": 5448n,
        "operations": [
          {
            "address": "0x5FbDB2315678afecb367f032d93F642f64180aa3",
            "fieldName": "amount",
            "fieldValue": 8,
            "key": {
              "item": 1,
              "itemVariant": 1,
              "owner": "0x796eb990A3F9C431C69149c7a168b91596D87F60",
            },
            "log": {
              "address": "0x5fbdb2315678afecb367f032d93f642f64180aa3",
              "args": {
                "data": "0x00000008",
                "key": [
                  "0x000000000000000000000000796eb990a3f9c431c69149c7a168b91596d87f60",
                  "0x0000000000000000000000000000000000000000000000000000000000000001",
                  "0x0000000000000000000000000000000000000000000000000000000000000001",
                ],
                "schemaIndex": 0,
                "table": "0x00000000000000000000000000000000496e76656e746f727900000000000000",
              },
              "blockHash": "0x03e962e7402b2ab295b92feac342a132111dd14b0d1fd4d4a0456fdc77981577",
              "blockNumber": 5448n,
              "data": "0x00000000000000000000000000000000496e76656e746f7279000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000796eb990a3f9c431c69149c7a168b91596d87f600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000040000000800000000000000000000000000000000000000000000000000000000",
              "eventName": "StoreSetField",
              "logIndex": 88,
              "removed": false,
              "topics": [
                "0xd01f9f1368f831528fc9fe6442366b2b7d957fbfff3bcf7c24d9ab5fe51f8c46",
              ],
              "transactionHash": "0xa6986924609542dc4c2d81c53799d8eab47109ef34ee1e422de595e19ee9bfa4",
              "transactionIndex": 88,
            },
            "name": "Inventory",
            "namespace": "",
            "type": "SetField",
          },
        ],
      }
    `);
  });
});
